{% extends 'base.html' %}
{% load i18n %}
{% load data_manipulation %}

{% block content %}

<style type="text/css" media="screen">

.stats h2 {
    font-size: 17px;
    color: #2196F3;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
    margin: 1em 0 0.3em;
}

.stats p {
    margin: 0;
}

.stats span.label {
    padding: 0;
    background: none;
    color: black;
}

.datatable {
    display: table;
    width: 100%;
    font-size: 12px;
}

.datatable td, .datatable th {
    border-left: none;
    border-right: none;
    border-bottom: 1px solid #A5B3BC;
    text-align: left;
}

.datatable td {
    padding: 5px;
    min-width: 0px;
    max-width: 150px;
}

.datatable th {
    padding: 8px 5px;
}

.datatable td:nth-child(2), .datatable td:nth-child(3) {
    width: 25%;
}

.stats {
    margin: 0 10% 39px;
}

.datatable thead {
    background-color: #2196F3;
    color: white;
    font-weight: bold;
}

.datagraph {
    font-size: 10px;
    text-align: center;
    width: 80%;
    margin: 20px 10% 20px;
    height: 500;
    padding-top: 50px;
}

.summarystats {
    color: #7D8A93;
    font-size: 11px;
}

.summarystats__provided {
    font-weight: bold;
}

.datatable--advancedstats {
    width: 80%;
    margin-left: 10%;
}

.more-results, .hiddenrows {
  display:none;
}
</style>

<h1>{{ title }}</h1>

{% for name, group in stats  %}

  <div class="stats">

    <h2>{{ name }}</h2>

    <table class="datatable datatable--summarystats">
      <thead>
        <tr>
          <th>{{ group_by }}</th>
          <th>{% trans "Submissions with data" %}</th>
          <th>{% trans "Submissions without data" %}</th>
          <th>{% trans "Total submissions" %}</th>
        </tr>
      </thead>
      <tbody>

        {% for group_name, stat in group %}

          <tr>

            <td>{{ group_name }}</td>
            <td>{{ stat.provided }}</td>
            <td>{{ stat.not_provided }}</td>
            <td>{{ stat.total_count }}</td>

          </tr>

        {% endfor %}

      </tbody>
    </table>

      {% if group.1.0.show_graph %}
        <div class="datagraph"><span>Graph will come here later on</span></div>
      {% endif %}

      {# when you got frequency, you have a table with metrics #}
      {% if group.0.1.frequency %}

        <table class="datatable datatable--basicstats">
          <thead>
            <tr>
              <th>{{ group_by }}</th>
              <th>{% trans "Value" %}</th>
              <th>{% trans "Frequency" %}</th>
              <th>{% trans "Percentage" %}</th>
            </tr>
          </thead>
          <tbody>

            {% for group_name, stat in group  %}

              {% comment %}
                These stats are grouped, and the group name span on as many
                rows as there are values inside that group
              {% endcomment %}
              <tr {% if forloop.counter > 10 %}class="hiddenrows"{% endif %}
                  rowspan="{{ stat.frequency|length }}"
              >
              
              <td rowspan="{{ stat.frequency|length }}" >{{ group_name }}</td>

                {% for answer, _ in stat.frequency %}

                    {% comment %}
                      After the first row, the cell containing the group
                      name is not repeated (since it uses rowspan) so
                      we need to start the row here.
                    {% endcomment %}
                    {% if forloop.counter > 1 %}
                      <tr>
                    {% endif %}

                      <td>
                      {{ answer }}
                      </td>

                      <td>
                      {{ stat.frequency|index:forloop.counter0|index:1 }}
                      </td>

                      <td> {{ stat.percentage|index:forloop.counter0|index:1 }}%</td>

                    {% if forloop.counter > 1 %}
                      </tr>
                    {% endif %}


                {% endfor %}

              </tr>

            {% endfor %}

          </tbody>
        </table>

        <p class="more-results"><a href="#">Show more results</a></p>

      {% endif %}

      {% if group.1.mean %}

      <table class="datatable datatable--advancedstats">
          <thead>
            <tr>
              <th>{{ group_by }}</th>
              <th>{% trans "Mean" %}</th>
              <th>{% trans "Median" %}</th>
              <th>{% trans "Mode" %}</th>
              <th>{% trans "Standard deviation" %}</th>
            </tr>
          </thead>
          <tbody>

            {% for group_name, stat in group  %}
              <tr>
                  <td> {{ group_name  }}</td>
                  <td> {{ stat.mean  }}</td>
                  <td> {{ stat.median  }}</td>
                  <td> {{ stat.mode  }}</td>
                  <td> {{ stat.stdev  }}</td>
              </tr>
            {% endfor %}


          </tbody>
        </table>

      {% endif %}

    </div>

{% endfor %}

<div id="pagination">
    {{ page.render }}
</div>

{% endblock %}

{% block javascript %}
{{ block.super }}

<script type="text/javascript" src="{{STATIC_URL}}js/Chart.min.js"></script>

<script>
$('.datatable--basicstats').each(function(){

   var dataset = [];
   var labels = [];
   var group = "";
   var label = "";

   $this = $(this);

   $this.find('tbody tr').each(function(){
     var $td = $(this).children();
     if ($td.length == 4){
        var $group = $td.first();
        group = $group.text()
        label = group + "/" + $group.next().text();
     } else {
        label = group + "/" + $td.text();
     }

     var percent = $(this).children().last().text();
     dataset.push(parseFloat(percent));
     labels.push(label);
   })

   if (dataset.length >= 10) {
    var hiddenRows = $this.find('.hiddenrows');
    var $link = $this.siblings('.more-results');
    $link.show().click(function(e){
      hiddenRows.show();
      $link.hide();
      e.preventDefault();
      e.stopPropagation();
    })
   }

   var $canvas = $('<canvas width="500" height="400"></canvas>')
   $(this).siblings('.datagraph').html('').append($canvas)

    // Get the context of the canvas element we want to select
    var ctx = $canvas[0].getContext("2d");

    var data = {
        labels: labels.slice(0, 10),
        datasets: [
            {
                fillColor: "rgba(151,187,205,0.2)",
                strokeColor: "rgba(151,187,205,1)",
                pointColor: "rgba(151,187,205,1)",
                pointStrokeColor: "#fff",
                pointHighlightFill: "#fff",
                pointHighlightStroke: "rgba(151,187,205,1)",
                data: dataset.slice(0, 10)
            }
        ]
    };

    var myNewChart = new Chart(ctx).Bar(data);

})

</script>

{% endblock %}
